<script>
  import { page } from "$app/stores";
  import { Avatar, ArtworkMedia, Heart } from "$comp";
  import { edition, painting, variation } from "$lib/store";
  import countdown from "$lib/countdown";
  import { units } from "$lib/utils";
  import { onDestroy, onMount } from "svelte";

  export let justScrolled = false;
  export let artwork;
  export let columns = 3;
  export let showDetails = true;
  export let loaded = false;
  export let thumb = true;
  export let popup = false;

  let sats, val, ticker;
  $: if (artwork) [sats, val, ticker] = units(artwork.asking_asset);

  let width = "full";
  if (columns > 1) {
    width = "1/" + columns;
  }

  let timeout;
  let start_counter, end_counter;
  let auction_underway;
  let count = () => {
    if (!artwork) return;
    start_counter = countdown(new Date(artwork.auction_start));
    end_counter = countdown(new Date(artwork.auction_end));
    timeout = setTimeout(count, 1000);

    let now = new Date();
    auction_underway = now > new Date(artwork.auction_start) && now < new Date(artwork.auction_end);
  };

  onMount(count);
  onDestroy(() => clearTimeout(timeout));

  let makeSelection = (e) => {
    if (
      $page.url.pathname.includes("agri") &&
      artwork.title.startsWith("Vida") &&
      !$variation
    )
      e.preventDefault();

    window.scrollTo(0, 0);
    let words = artwork.title.split(" ");
    let n = parseInt(words[words.length - 1]);

    if (!$painting) {
      $painting = n;
    } else if (!$variation) {
      $variation = n;
    } else {
      $edition = n;
    }
  };

  let words, n, step, st, end;
  $: update(artwork, $painting, $variation, $edition);
  let update = (a, p, v) => {
    words = artwork.title.split(" ");
    n = parseInt(words[words.length - 1]);
    step = p ? 10 : 100;
    st = n - step + 1;
    end = n;
  };

  $: title =
    $variation || !artwork.title.startsWith("Harvest")
      ? artwork.title
      : `Shares ${st}-${end}`;
</script>

<div
  class="{showDetails ? 'card' : ''} flex flex-col justify-between h-full"
  key={artwork.id}
>
  <a href={`/a/${artwork.slug}`} on:click={makeSelection}>
    {#if !loaded && justScrolled}
      <div style="height: 350px" class="bg-gray-100 w-full object-cover" />
    {:else}
      <ArtworkMedia {artwork} {showDetails} {popup} bind:loaded bind:thumb />
    {/if}
  </a>
  {#if showDetails}
    <div class="p-4">
      <div class="flex flex-row justify-between mb-2">
        <a href={`/a/${artwork.slug}`} on:click={makeSelection}>
          <div>
            <h1 class="text-xl">
              {title}
              {#if !(artwork.transferred_at || artwork.asking_asset)}
                (unlisted)
              {/if}
            </h1>
            {#if artwork.editions > 1}
              <h2 class="text-sm text-gray-400 font-light">
                Edition
                {artwork.edition}
                of
                {artwork.editions}
              </h2>
            {/if}
          </div>
        </a>
        <Heart {artwork} />
      </div>
      <div class="flex mb-4">
        <div class="1/2 flex-1">
          <div class="price">
            {#if artwork.list_price}{val(artwork.list_price)}{:else}&mdash;{/if}
            {ticker}
          </div>
          <div class="w-1/2 text-sm font-medium">List Price</div>
        </div>
        {#if artwork.bid && artwork.bid.user}
          <div class="1/2 flex-1">
            <div class="price">{val(artwork.bid.amount)} {ticker}</div>
            <div class="text-sm font-medium">
              Current bid by
              <a href={`/${artwork.bid.user.username}`}
                >@{artwork.bid.user.username}</a
              >
            </div>
          </div>
        {/if}
      </div>
      <div class="flex">
        <div>
          <a href={`/${artwork.artist.username}`}>
            <div class="flex">
              <Avatar user={artwork.artist} />
              <div class="ml-2">
                <div class="break-all">@{artwork.artist.username}</div>
                <div class="text-xs text-gray-300">Creator</div>
              </div>
            </div>
          </a>
        </div>

        {#if artwork.owner.id !== artwork.artist.id}
          <div class="ml-auto">
            <a href={`/${artwork.owner.username}`}>
              <div class="flex">
                <Avatar user={artwork.owner} />
                <div class="ml-2">
                  <div class="break-all">@{artwork.owner.username}</div>
                  <div class="text-xs text-gray-300">Owner</div>
                </div>
              </div>
            </a>
          </div>
        {/if}
      </div>
    </div>
    {#if auction_underway}
      <div class="p-3 rounded-b-lg lightblue-grad text-black mt-auto">
        Time left:
        {end_counter}
      </div>
    {:else if start_counter}
      <div class="p-3 rounded-b-lg lightblue-grad text-black mt-auto">
        Starts in:
        {start_counter}
      </div>
    {:else}
      <div class="p-3 rounded-b-lg">&nbsp;</div>
    {/if}
  {/if}
</div>

<style>
  .card {
    border-radius: 10px;
    @apply shadow-md;
  }

  .card :global(img),
  .card :global(video) {
    border-radius: 10px 10px 0 0;
  }

  .price {
    font-size: 15px;
  }
</style>
